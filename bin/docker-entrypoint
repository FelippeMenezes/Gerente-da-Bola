#!/bin/bash
set -e

echo "Entrypoint: Starting database configuration override (sed version)..."

# O Koyeb passa a DATABASE_URL como um JSON.
# Vamos extrair a senha usando apenas 'sed', que sempre está presente.
DB_SECRET_JSON=$DATABASE_URL

# Usa 'sed' para remover tudo antes de '"password":"' e tudo depois do '"' final.
DB_PASSWORD=$(echo "$DB_SECRET_JSON" | sed -n 's/.*"password":"\([^"]*\)".*/\1/p')

# Valores fixos que já conhecemos
DB_USER="koyeb"
DB_HOST="ep-restless-feather-a4vieac2.us-east-1.pg.koyeb.app"
DB_NAME="koyebdb"

# Constrói o novo e correto DATABASE_URL
export DATABASE_URL="postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}/${DB_NAME}"

echo "Entrypoint: New DATABASE_URL constructed. Running migrations..."

# Rode as migrations
bundle exec rails db:migrate

# Inicie a aplicação
echo "Entrypoint: Starting the main application..."
exec "$@"